# 友链RSS聚合插件

一个为 Typecho 博客系统开发的友链RSS聚合插件，自动获取友链博客的最新文章并生成RSS聚合feed。

## 功能特性

- 🔍 **智能RSS检测** - 采用"三轮检测"策略，自动检测友链博客的RSS地址
- 📰 **文章聚合** - 聚合所有友链博客的最新文章，支持多格式（RSS 2.0/Atom 1.0/RSS 1.0）
- 🎨 **美观前台** - 提供现代化的前台展示页面
- 📡 **RSS输出** - 生成标准的RSS 2.0格式聚合feed
- ⚡ **智能缓存** - RSS地址缓存与定时检测同步，文章内容缓存与定时解析同步
- 🛠️ **后台管理** - 完整的后台管理界面，包含统计卡片和操作卡片
- 📊 **统计信息** - 显示友链数量、文章数量、可用分类等统计数据
- 🔧 **灵活配置** - 支持友链分类、定时解析、排除网址等多项配置
- 🕒 **定时解析** - 支持配置定时解析间隔，提供独立的定时任务脚本
- 🔍 **定时检测** - 支持配置定时检测RSS地址间隔，RSS地址缓存自动同步
- 🔒 **并发保护** - 内置锁文件机制，防止重复聚合任务

## 系统要求

- Typecho 1.2.1+
- PHP 7.0+（推荐 PHP 8.0+）
- PHP扩展：SimpleXML、cURL（推荐）
- 友链数据表（通常由友链管理插件创建）

## 安装方法

1. 下载插件文件
2. 解压到 `usr/plugins/FriendsRSS/` 目录
3. 在后台「控制台」→「插件」中激活插件
4. 根据需要调整插件配置

## 配置选项

### 基本设置

- **友链分类** - 指定需要聚合的友链分组
  - Handsome主题：填写"ten"获取全站链接，填写"one"获取内页链接，填写"good"获取推荐链接
  - 其他主题：通常留空即可，插件会自动获取所有友链
  - 当指定分类不存在时，插件会自动获取所有友链，确保兼容性
- **每个博客文章数** - 每个友链博客获取的最大文章数量，默认5篇
- **最大文章数** - RSS聚合显示的最大文章数量，默认20篇
- **定时解析间隔** - 定时解析友链RSS的间隔时间（小时），默认6小时，设置为0表示禁用
- **定时检测间隔** - 定时检测友链RSS地址的间隔时间（小时），默认240小时（10天），设置为0表示禁用
- **启用前台展示** - 是否开放前台聚合页与RSS输出

## 使用方法

### RSS订阅地址
```
你的网站/action/friends-rss?do=rss
```

### 前台展示页面
```
你的网站/action/friends-rss?do=page
```

### 前台展示页面（预览）
```
你的网站/action/friends-rss?do=pageview
```

### RSS短代码
在文章或页面中使用 `[rss]` 短代码显示友链RSS聚合内容：

```
[rss]                    # 显示10篇最新文章
[rss limit="5"]         # 显示5篇最新文章
[rss limit="20"]        # 显示20篇最新文章
```

### 后台管理
在 Typecho 后台「控制台」→「友链RSS」中进行管理。

## RSS检测规则

插件采用"三轮检测"策略：

1. **第一轮**：常用路径检测
   - `/feed`、`/feed.xml`、`/rss.xml`、`/atom.xml`、`/index.xml`
   - `/feed/`、`/rss/`、`/atom/`

2. **第二轮**：HTML解析检测
   - 解析HTML页面中的RSS链接标签
   - 支持 `<link rel="alternate" type="application/rss+xml">` 等格式

3. **第三轮**：其他常见路径检测
   - 尝试其他可能的RSS路径

支持RSS 2.0、Atom 1.0和RSS 1.0格式的feed。

## 缓存机制

### 缓存策略

| 缓存类型 | 缓存时间 | 说明 |
|----------|----------|------|
| **RSS地址缓存** | 与定时检测间隔一致 | RSS地址相对稳定，与定时检测间隔同步，减少重复检测 |
| **文章内容缓存** | 与定时解析间隔一致 | 确保定时解析有意义，避免缓存过期后立即重新解析 |
| **失败结果缓存** | 1小时 | 避免重复请求失败的RSS源，减少服务器压力 |

### 定时策略

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| **定时解析间隔** | 6小时 | 定时解析友链RSS的间隔时间，设置为0表示禁用 |
| **文章缓存时间** | 自动同步 | 与定时解析间隔保持一致，确保定时解析有意义 |
| **定时检测间隔** | 240小时（10天） | 定时检测友链RSS地址的间隔时间，设置为0表示禁用 |
| **RSS地址缓存时间** | 自动同步 | 与定时检测间隔保持一致，减少重复检测 |
| **实际效果** | 缓存过期时重新执行 | 定时任务执行时缓存刚好过期，获取最新内容 |

- 聚合文章缓存在 `usr/cache/friends_rss/` 目录
- 缓存文件：`aggregated_articles.json`
- 可在后台管理页面手动清除缓存
- 缓存过期后自动重新获取最新内容

## 文件结构

```
FriendsRSS/
├── Plugin.php          # 插件主文件
├── Action.php          # Action处理器
├── Core.php            # RSS聚合核心类
├── admin.php           # 后台管理页面
├── ajax.php            # AJAX处理
├── cron.php            # 定时任务脚本
├── template/
│   └── page.php        # 前台展示模板
├── COMPATIBILITY.md    # 兼容性文档
├── CRON_SETUP.md       # 定时任务设置文档
├── SHORTCODE_USAGE.md  # 短代码使用文档
└── README.md           # 说明文档
```

## 后台管理功能

- 📊 **统计卡片** - 显示友链数量、文章数量、可用分类、最后更新时间
- 🛠️ **操作卡片** - 检测RSS地址、定时解析RSS内容、添加RSS地址
- 🔗 **访问地址** - 显示RSS订阅、前台页面、预览页面地址
- 📋 **友链列表** - 显示所有友链及其RSS检测状态
- 📰 **最新文章** - 预览聚合的最新文章
- 📝 **日志显示** - 显示操作日志和错误日志

## 输出限制

为了保证性能和用户体验：

- 默认最多聚合20篇文章
- 每个博客最多获取5篇文章
- 文章描述截取前200字符
- 请求超时时间为10秒
- 支持并发保护，避免重复任务

## 安全考虑

- 用户权限检查（仅管理员可访问后台）
- URL安全验证
- XSS防护（HTML转义）
- 请求超时限制
- 缓存目录权限控制
- 锁文件机制防止并发问题

## 故障排除

### 常见问题

1. **无法获取RSS内容**
   - 检查PHP的cURL扩展是否启用
   - 确认服务器可以访问外部网络
   - 检查友链博客的RSS地址是否有效

2. **缓存目录权限错误**
   - 确保 `usr/cache/` 目录可写
   - 检查文件权限设置

3. **后台管理页面无法访问**
   - 确认插件已正确激活
   - 检查用户权限（需要管理员权限）

4. **友链数据为空**
   - 确认已安装友链管理插件
   - 检查友链分类设置是否正确
   - 查看"可用分类"统计卡片确认分类状态

5. **定时解析不工作**
   - 检查定时任务脚本权限
   - 确认服务器支持cron任务
   - 查看错误日志排查问题

### 调试方法

1. 在后台管理页面使用"检测RSS地址"功能
2. 检查 `usr/cache/friends_rss/` 目录下的缓存文件
3. 查看服务器错误日志
4. 使用"定时解析RSS内容"手动触发解析

## 技术支持

如果遇到问题或有功能建议，请：

1. 检查本文档的故障排除部分
2. 查看 `COMPATIBILITY.md` 兼容性文档
3. 确认系统要求是否满足
4. 联系插件作者获取技术支持

## 更新日志

### v2.2.1 (2025/8/31)
- **Bug** - 修复缓存机制导致RSS配置无法及时更新的问题：增加配置文件时间戳检查，当配置文件比缓存文件更新时自动强制刷新缓存
- **优化** - 增强RSS配置读取调试信息：添加详细的配置文件读取日志，特别针对特定友链配置状态的检查和记录
- **优化** - 聚合文章时强制刷新RSS配置缓存：确保能读取到最新的手动配置RSS地址

### v2.2.0 (2025/8/31)
- **Bug** - 修复RSS配置文件和缓存目录缺失导致的配置读取失败问题：在构造函数中自动创建rss_config.json文件和缓存目录
- **优化** - 完善错误处理机制：增加文件读取、JSON解析和缓存操作的详细错误日志记录
- **优化** - 改进后台RSS配置保存逻辑：增加异常处理、文件存在检查和用户界面反馈

### v2.1.6 (2025/8/25)
- **功能** - 新增定时检测RSS功能：支持配置定时检测RSS地址间隔（默认240小时/10天）
- **功能** - 管理界面优化：新增"定时检测RSS地址"操作卡片，显示当前检测间隔和下次执行时间
- **功能** - 缓存策略优化：RSS地址缓存时间从固定7天改为与定时检测间隔同步
- **文档** - 新增RSS短代码使用说明，包含基本用法、参数说明、使用示例和设计特点
- **思路** - 以"逻辑一致性"为核心，确保定时检测与RSS地址缓存同步

### v2.1.5 (2025/8/25)
- **功能** - 友链分类兼容性增强：当指定分类不存在时，自动获取所有友链
- **功能** - 管理界面优化：新增"可用分类"统计卡片
- **功能** - 配置界面优化：友链分类设置项默认值改为空，添加详细兼容性说明
- **思路** - 以"最大兼容性"为核心，确保插件能在各种Typecho主题环境下正常工作

### v2.1.4 (2025/8/25)
- **Bug** - 修复日志显示错误：将"用时20s"等错误显示修正为实际请求用时
- **优化** - 管理界面体验优化：日志显示区域自动滚动到最新内容
- **文档** - 新增缓存策略和定时解析策略表格说明

### v2.1.3 (2025/8/25)
- **优化** - 缓存策略优化：RSS地址缓存时间延长至7天，文章内容缓存时间自动与定时解析间隔保持一致
- **功能** - 新增定时解析功能：支持配置定时解析间隔，提供独立的定时任务脚本
- **功能** - 简化配置界面：移除"缓存时间"设置项，避免用户困惑

### v2.1.2 (2025/8/25)
- **功能** - RSS缓存设置优化：将缓存时间单位从秒改为天，默认值调整为10天
- **功能** - 移除请求超时设置项：删除未使用的timeout配置项
- **功能** - 管理界面名称优化：统一命名规范，提升界面友好度

### v2.1.1 (2025/8/25)
- **功能** - 新增预览页面地址：在访问地址区域添加预览链接
- **功能** - 管理界面优化：将定时解析控制块替换解析RSS功能
- **功能** - 新增错误日志显示：在管理页面中显示error.log日志内容

### v2.0.4 (2025/8/24)
- **功能** - 后台"添加RSS地址"区域UI调整：输入框与选择框长度比例优化
- **Bug** - 解决Typecho默认select固定高度导致与输入框不对齐的问题

### v2.0.3 (2025/8/24)
- **功能** - 管理面板重构：新增统计卡片、操作卡片与访问地址区块
- **Bug** - 修复"最后更新"在无缓存时显示1970的问题，改为显示"暂无"

### v2.0.2 (2025/8/23)
- **功能** - 新增聚合任务锁文件机制；提供缓存清理与缓存统计
- **Bug** - 修复并发解析导致缓存文件被覆盖/损坏的偶发问题

### v2.0.1 (2025/8/23)
- **功能** - 引入三轮RSS自动检测；为检测结果设置24小时缓存
- **Bug** - 修复部分站点HTML中相对链接解析错误

### v2.0.0 (2025/8/23)
- **功能** - 解析器升级：支持RSS 2.0/Atom 1.0/RSS 1.0；清理与截断描述文本
- **Bug** - 修复特殊字符、BOM与控制字符导致XML解析失败的问题

### v1.5.0 (2025/8/23)
- **功能** - 提供聚合RSS输出与可选前台展示页面；后台展示最近文章与来源信息

### v1.4.0 (2025/8/23)
- **功能** - 支持多源聚合与发布时间排序；可配置"每博客文章数"与"聚合总数"

### v1.3.0 (2025/8/23)
- **功能** - 自动截断摘要，保证列表简洁可读

### v1.2.0 (2025/8/23)
- **功能** - 后台新增"手动添加RSS"能力，为自动检测失败站点提供纠偏

### v1.1.0 (2025/8/23)
- **功能** - 增加缓存时间、重定向上限与超时等基础性能参数配置

### v1.0.0 (2025/8/23)
- **功能** - 初始版本：多源RSS/Atom聚合、后台基础管理与展示

## 许可证

本插件采用 MIT 许可证发布。

## 作者

- 作者：璇
- 网站：https://blog.ybyq.wang/
- 版本：2.2.1